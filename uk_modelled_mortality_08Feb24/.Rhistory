TRUE ~ weighted_start_stage_4)) %>%
mutate(weighted_end_stage_1 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_1)) %>%
mutate(weighted_end_stage_2 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_2)) %>%
mutate(weighted_end_stage_3 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_3)) %>%
mutate(weighted_end_stage_4 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_4))
# SS_GROUP_BY_CANCER = c("NCRAS_Draw","scenario", "perc_skip","model_type")
np_SD_res <-  weighted_sd_no55 %>%
arrange(tAge) %>%
group_by_at(SS_GROUP_BY_CANCER) %>%
summarize(weighted_start_stage_1_SA = first(weighted_start_stage_1_prev), #to take the prevalence screen at age 50
weighted_start_stage_2_SA = first(weighted_start_stage_2_prev),
weighted_start_stage_3_SA = first(weighted_start_stage_3_prev),
weighted_start_stage_4_SA = first(weighted_start_stage_4_prev),
weighted_end_stage_1_SA = first(weighted_end_stage_1_prev),
weighted_end_stage_2_SA = first(weighted_end_stage_2_prev),
weighted_end_stage_3_SA = first(weighted_end_stage_3_prev),
weighted_end_stage_4_SA = first(weighted_end_stage_4_prev),
weighted_start_stage_1 = sum(weighted_start_stage_1), #to sum all incident rounds of screening age 51-79
weighted_start_stage_2 = sum(weighted_start_stage_2),
weighted_start_stage_3 = sum(weighted_start_stage_3),
weighted_start_stage_4 = sum(weighted_start_stage_4),
weighted_end_stage_1 = sum(weighted_end_stage_1),
weighted_end_stage_2 = sum(weighted_end_stage_2),
weighted_end_stage_3 = sum(weighted_end_stage_3),
weighted_end_stage_4 = sum(weighted_end_stage_4)) %>%
mutate(weighted_start_stage_1= weighted_start_stage_1 + weighted_start_stage_1_SA,
weighted_start_stage_2= weighted_start_stage_2 + weighted_start_stage_2_SA,
weighted_start_stage_3= weighted_start_stage_3 + weighted_start_stage_3_SA,
weighted_start_stage_4= weighted_start_stage_4 + weighted_start_stage_4_SA,
weighted_end_stage_1= weighted_end_stage_1 + weighted_end_stage_1_SA,
weighted_end_stage_2= weighted_end_stage_2 + weighted_end_stage_2_SA,
weighted_end_stage_3= weighted_end_stage_3 + weighted_end_stage_3_SA,
weighted_end_stage_4= weighted_end_stage_4 + weighted_end_stage_4_SA) %>%
ungroup()%>% #proportional change for each stage (weighted)
mutate(
weighted_stage_1_change = weighted_end_stage_1/weighted_start_stage_1,
weighted_stage_2_change = weighted_end_stage_2/weighted_start_stage_2,
weighted_stage_3_change = weighted_end_stage_3/weighted_start_stage_3,
weighted_stage_4_change = weighted_end_stage_4/weighted_start_stage_4,
)
#Filter to base case only
np_SD_res_base <- np_SD_res %>%
filter(scenario == "old_4",
perc_skip == 0,
model_type == "main")
#Output result
#write out excel file
write.xlsx(np_SD_res_base, sprintf("~/Miscellaneous/Treatments/interception_model_results/%s_np_SD_res_50reducedsens_55to79.xlsx", date_code))
library(tidyverse)
library(readxl)
library(openxlsx)
library(zoo)
library(gt)
library(Iso)
###############################
#Use alternative versions of 07_... scripts to generate alternative corrected resutls
###############################
#version output
date_code<-"29_05_2024_treatment_paper_results"
#define parameters used in the analysis
source("scripts/00_x_global_parameters_for55to75.R")
#useful functions
'%!in%' <- function(x,y)!('%in%'(x,y)) #function to select not
#settings
options(scipen = 100) #remove scientific notation
#utility functions
source("R/compute_stage_shift.R") #changed to 2, included prevalence round shifts
source("R/compute_lead_time.R")
source("R/slip_rate_from_dwell.R")
source("R/compute_mortality_models.R")
source("R/compute_split_survival.R")
#execute actual operations
source("scripts/prep_inc_spline.R")
#source("scripts/old/prep_inc.R")
source("scripts/01_get_incidence.R")
source("scripts/02_retrieve_dwell.R")
#generate isotonic adjusted sensitivity and use
source("scripts/prep_sens.R")
source("scripts/03_sensitivity_table.R")
final_sens_table <- final_sens_table %>%
mutate(sens = sens * 0.5)
#do interception model stage shift for all scenarios, ages, simultaneously
source("scripts/04_execute_parallel_interception.R")
#start doing survival/mortality analysis
#precompute interpolated survival curves by age
source("scripts/prep_surv.R")
source("scripts/generate_css_by_age.R")
#adjust models for fraction of cancers that behave metastatically
source("scripts/05_merge_models.R")
#just 5 years survival, combine with interception
#split survival for cfdna+ and cfdna-
source("scripts/06_add_split_survival_to_models.R") # to include results for the sensitivity analyses
#Open cohort and single birth cohort through the full screening programme results from full combinatorial results
#source("scripts/07_cohorts_results_stage_skip_correct_w.R") #age-weighted based on attrition assumptions
source("scripts/07_cohorts_results_stage_skip_correct_w_140324.R")
View(interception_stage_shift_ALL_w)
#Stage distributions after introduction of screening
#For treatment impact manuscript
#All analysis will use base case assumption of fast (aggfast/old_4) dwell times
################################################################################
#____ Scenario 1 - 100% uptake
#Long-run steady state scenario, screening from age 50 to age 79 annual
#Base case 100% uptake
#We want to extract absolute and proportional change in incidence by stage for each cancer type following the singe age cohort scenario
# Stage distribtion -----------------------------------------------------
# Get incidence by stage when screening is applied and when it is not applied
#prequel is stage diagnosed with MCED screening
#clinical is stage diagnosed without MCED screening
#repeated for prevalence round, no suffix = incidence round (1 year interval)
stage_dist_by_cancer <- interception_stage_shift_ALL_w %>%
filter(clinical < 5 & prequel < 5) %>% #Remove those not staged
mutate(
end_stage_1 = ifelse(prequel == 1, 1, 0) * caught,#incidence rounds
end_stage_2 = ifelse(prequel == 2, 1, 0) * caught,
end_stage_3 = ifelse(prequel == 3, 1, 0) * caught,
end_stage_4 = ifelse(prequel == 4, 1, 0) * caught,
end_stage_1_prev = ifelse(prequel == 1, 1, 0) * prevalence_caught,#prevalence rounds
end_stage_2_prev = ifelse(prequel == 2, 1, 0) * prevalence_caught,
end_stage_3_prev = ifelse(prequel == 3, 1, 0) * prevalence_caught,
end_stage_4_prev = ifelse(prequel == 4, 1, 0) * prevalence_caught,
start_stage_1 = ifelse(clinical == 1, 1, 0) * caught,#incidence rounds
start_stage_2 = ifelse(clinical == 2, 1, 0) * caught,
start_stage_3 = ifelse(clinical == 3, 1, 0) * caught,
start_stage_4 = ifelse(clinical == 4, 1, 0) * caught,
start_stage_1_prev = ifelse(clinical == 1, 1, 0) * prevalence_caught,#prevalence rounds
start_stage_2_prev = ifelse(clinical == 2, 1, 0) * prevalence_caught,
start_stage_3_prev = ifelse(clinical == 3, 1, 0) * prevalence_caught,
start_stage_4_prev = ifelse(clinical == 4, 1, 0) * prevalence_caught
) %>%
group_by_at(SS_GROUP_AGE_BY_CANCER) %>%
summarize(
end_stage_1 = sum(end_stage_1),#incidence rounds
end_stage_2 = sum(end_stage_2),
end_stage_3 = sum(end_stage_3),
end_stage_4 = sum(end_stage_4),
end_stage_1_prev = sum(end_stage_1_prev),#prevalence rounds
end_stage_2_prev = sum(end_stage_2_prev),
end_stage_3_prev = sum(end_stage_3_prev),
end_stage_4_prev = sum(end_stage_4_prev),
start_stage_1 = sum(start_stage_1),#incidence rounds
start_stage_2 = sum(start_stage_2),
start_stage_3 = sum(start_stage_3),
start_stage_4 = sum(start_stage_4),
start_stage_1_prev = sum(start_stage_1_prev),#prevalence rounds
start_stage_2_prev = sum(start_stage_2_prev),
start_stage_3_prev = sum(start_stage_3_prev),
start_stage_4_prev = sum(start_stage_4_prev)
) %>% #proportional change for each stage
ungroup() %>%
mutate(
stage_1_change = end_stage_1/start_stage_1,
stage_2_change = end_stage_2/start_stage_2,
stage_3_change = end_stage_3/start_stage_3,
stage_4_change = end_stage_4/start_stage_4,
stage_1_change_prev = end_stage_1_prev/start_stage_1_prev,
stage_2_change_prev = end_stage_2_prev/start_stage_2_prev,
stage_3_change_prev = end_stage_3_prev/start_stage_3_prev,
stage_4_change_prev = end_stage_4_prev/start_stage_4_prev
)
# Apply weights to stage distribution results ------------------------------------
#Weights as in MM, account for attrition in steady state programme with invitations starting at 50
#join weights to stage shift, by cancer
weighted_stage_dist_by_cancer <- stage_dist_by_cancer %>%
left_join(weight_screened_by_scenario, by = c("tAge","scenario","perc_skip","model_type"))  %>%
mutate(
weighted_end_stage_1 = end_stage_1 * weight,
weighted_end_stage_2 = end_stage_2 * weight,
weighted_end_stage_3 = end_stage_3 * weight,
weighted_end_stage_4 = end_stage_4 * weight,
weighted_end_stage_1_prev = end_stage_1_prev * weight,
weighted_end_stage_2_prev = end_stage_2_prev * weight,
weighted_end_stage_3_prev = end_stage_3_prev * weight,
weighted_end_stage_4_prev = end_stage_4_prev * weight,
weighted_start_stage_1 = start_stage_1 * weight,
weighted_start_stage_2 = start_stage_2 * weight,
weighted_start_stage_3 = start_stage_3 * weight,
weighted_start_stage_4 = start_stage_4 * weight,
weighted_start_stage_1_prev = start_stage_1_prev * weight,
weighted_start_stage_2_prev = start_stage_2_prev * weight,
weighted_start_stage_3_prev = start_stage_3_prev * weight,
weighted_start_stage_4_prev = start_stage_4_prev * weight,
)
#aggregate across ages - age-weighted
w_SD_by_cancer <- weighted_stage_dist_by_cancer %>%
group_by_at(SS_GROUP_BY_CANCER) %>%
summarize(
weighted_start_stage_1 = sum(weighted_start_stage_1)/sum(weight),
weighted_start_stage_2 = sum(weighted_start_stage_2)/sum(weight),
weighted_start_stage_3 = sum(weighted_start_stage_3)/sum(weight),
weighted_start_stage_4 = sum(weighted_start_stage_4)/sum(weight),
weighted_end_stage_1 = sum(weighted_end_stage_1)/sum(weight),
weighted_end_stage_2 = sum(weighted_end_stage_2)/sum(weight),
weighted_end_stage_3 = sum(weighted_end_stage_3)/sum(weight),
weighted_end_stage_4 = sum(weighted_end_stage_4)/sum(weight),
weighted_start_stage_1_prev = sum(weighted_start_stage_1_prev)/sum(weight),
weighted_start_stage_2_prev = sum(weighted_start_stage_2_prev)/sum(weight),
weighted_start_stage_3_prev = sum(weighted_start_stage_3_prev)/sum(weight),
weighted_start_stage_4_prev = sum(weighted_start_stage_4_prev)/sum(weight),
weighted_end_stage_1_prev = sum(weighted_end_stage_1_prev)/sum(weight),
weighted_end_stage_2_prev = sum(weighted_end_stage_2_prev)/sum(weight),
weighted_end_stage_3_prev = sum(weighted_end_stage_3_prev)/sum(weight),
weighted_end_stage_4_prev = sum(weighted_end_stage_4_prev)/sum(weight)
) %>%
ungroup()%>% #proportional change for each stage (weighted)
mutate(
weighted_stage_1_change = weighted_end_stage_1/weighted_start_stage_1,
weighted_stage_2_change = weighted_end_stage_2/weighted_start_stage_2,
weighted_stage_3_change = weighted_end_stage_3/weighted_start_stage_3,
weighted_stage_4_change = weighted_end_stage_4/weighted_start_stage_4,
weighted_stage_1_change_prev = weighted_end_stage_1_prev/weighted_start_stage_1_prev,
weighted_stage_2_change_prev = weighted_end_stage_2_prev/weighted_start_stage_2_prev,
weighted_stage_3_change_prev = weighted_end_stage_3_prev/weighted_start_stage_3_prev,
weighted_stage_4_change_prev = weighted_end_stage_4_prev/weighted_start_stage_4_prev
)
#birth cohort results - stage distribution
#prevalence round at age 55 + sum of all the incidence rounds from 56
#remove the incidence round at age 50, so as not to double count it
weighted_sd_no55 = weighted_stage_dist_by_cancer %>%
mutate(weighted_start_stage_1 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_1)) %>%
mutate(weighted_start_stage_2 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_2)) %>%
mutate(weighted_start_stage_3 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_3)) %>%
mutate(weighted_start_stage_4 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_4)) %>%
mutate(weighted_end_stage_1 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_1)) %>%
mutate(weighted_end_stage_2 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_2)) %>%
mutate(weighted_end_stage_3 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_3)) %>%
mutate(weighted_end_stage_4 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_4))
# SS_GROUP_BY_CANCER = c("NCRAS_Draw","scenario", "perc_skip","model_type")
np_SD_res <-  weighted_sd_no55 %>%
arrange(tAge) %>%
group_by_at(SS_GROUP_BY_CANCER) %>%
summarize(weighted_start_stage_1_SA = first(weighted_start_stage_1_prev), #to take the prevalence screen at age 50
weighted_start_stage_2_SA = first(weighted_start_stage_2_prev),
weighted_start_stage_3_SA = first(weighted_start_stage_3_prev),
weighted_start_stage_4_SA = first(weighted_start_stage_4_prev),
weighted_end_stage_1_SA = first(weighted_end_stage_1_prev),
weighted_end_stage_2_SA = first(weighted_end_stage_2_prev),
weighted_end_stage_3_SA = first(weighted_end_stage_3_prev),
weighted_end_stage_4_SA = first(weighted_end_stage_4_prev),
weighted_start_stage_1 = sum(weighted_start_stage_1), #to sum all incident rounds of screening age 51-79
weighted_start_stage_2 = sum(weighted_start_stage_2),
weighted_start_stage_3 = sum(weighted_start_stage_3),
weighted_start_stage_4 = sum(weighted_start_stage_4),
weighted_end_stage_1 = sum(weighted_end_stage_1),
weighted_end_stage_2 = sum(weighted_end_stage_2),
weighted_end_stage_3 = sum(weighted_end_stage_3),
weighted_end_stage_4 = sum(weighted_end_stage_4)) %>%
mutate(weighted_start_stage_1= weighted_start_stage_1 + weighted_start_stage_1_SA,
weighted_start_stage_2= weighted_start_stage_2 + weighted_start_stage_2_SA,
weighted_start_stage_3= weighted_start_stage_3 + weighted_start_stage_3_SA,
weighted_start_stage_4= weighted_start_stage_4 + weighted_start_stage_4_SA,
weighted_end_stage_1= weighted_end_stage_1 + weighted_end_stage_1_SA,
weighted_end_stage_2= weighted_end_stage_2 + weighted_end_stage_2_SA,
weighted_end_stage_3= weighted_end_stage_3 + weighted_end_stage_3_SA,
weighted_end_stage_4= weighted_end_stage_4 + weighted_end_stage_4_SA) %>%
ungroup()%>% #proportional change for each stage (weighted)
mutate(
weighted_stage_1_change = weighted_end_stage_1/weighted_start_stage_1,
weighted_stage_2_change = weighted_end_stage_2/weighted_start_stage_2,
weighted_stage_3_change = weighted_end_stage_3/weighted_start_stage_3,
weighted_stage_4_change = weighted_end_stage_4/weighted_start_stage_4,
)
#Filter to base case only
np_SD_res_base <- np_SD_res %>%
filter(scenario == "old_4",
perc_skip == 0,
model_type == "main")
#Output result
#write out excel file
write.xlsx(np_SD_res_base, sprintf("~/Miscellaneous/Treatments/interception_model_results/%s_np_SD_res_50reducedsens_55to74.xlsx", date_code))
library(tidyverse)
library(readxl)
library(openxlsx)
library(zoo)
library(gt)
library(Iso)
###############################
#Use alternative versions of 07_... scripts to generate alternative corrected resutls
###############################
#version output
date_code<-"29_05_2024_treatment_paper_results"
#define parameters used in the analysis
source("scripts/00_x_global_parameters_for55to75.R")
#useful functions
'%!in%' <- function(x,y)!('%in%'(x,y)) #function to select not
#settings
options(scipen = 100) #remove scientific notation
#utility functions
source("R/compute_stage_shift.R") #changed to 2, included prevalence round shifts
source("R/compute_lead_time.R")
source("R/slip_rate_from_dwell.R")
source("R/compute_mortality_models.R")
source("R/compute_split_survival.R")
#execute actual operations
source("scripts/prep_inc_spline.R")
#source("scripts/old/prep_inc.R")
source("scripts/01_get_incidence.R")
source("scripts/02_retrieve_dwell.R")
#generate isotonic adjusted sensitivity and use
source("scripts/prep_sens.R")
source("scripts/03_sensitivity_table.R")
final_sens_table <- final_sens_table %>%
mutate(sens = sens * 0.5)
#do interception model stage shift for all scenarios, ages, simultaneously
source("scripts/04_execute_parallel_interception.R")
#start doing survival/mortality analysis
#precompute interpolated survival curves by age
source("scripts/prep_surv.R")
source("scripts/generate_css_by_age.R")
#adjust models for fraction of cancers that behave metastatically
source("scripts/05_merge_models.R")
#just 5 years survival, combine with interception
#split survival for cfdna+ and cfdna-
source("scripts/06_add_split_survival_to_models.R") # to include results for the sensitivity analyses
#Open cohort and single birth cohort through the full screening programme results from full combinatorial results
#source("scripts/07_cohorts_results_stage_skip_correct_w.R") #age-weighted based on attrition assumptions
source("scripts/07_cohorts_results_stage_skip_correct_w_140324.R")
#Stage distributions after introduction of screening
#For treatment impact manuscript
#All analysis will use base case assumption of fast (aggfast/old_4) dwell times
################################################################################
#____ Scenario 1 - 100% uptake
#Long-run steady state scenario, screening from age 50 to age 79 annual
#Base case 100% uptake
#We want to extract absolute and proportional change in incidence by stage for each cancer type following the singe age cohort scenario
# Stage distribtion -----------------------------------------------------
# Get incidence by stage when screening is applied and when it is not applied
#prequel is stage diagnosed with MCED screening
#clinical is stage diagnosed without MCED screening
#repeated for prevalence round, no suffix = incidence round (1 year interval)
stage_dist_by_cancer <- interception_stage_shift_ALL_w %>%
filter(clinical < 5 & prequel < 5) %>% #Remove those not staged
mutate(
end_stage_1 = ifelse(prequel == 1, 1, 0) * caught,#incidence rounds
end_stage_2 = ifelse(prequel == 2, 1, 0) * caught,
end_stage_3 = ifelse(prequel == 3, 1, 0) * caught,
end_stage_4 = ifelse(prequel == 4, 1, 0) * caught,
end_stage_1_prev = ifelse(prequel == 1, 1, 0) * prevalence_caught,#prevalence rounds
end_stage_2_prev = ifelse(prequel == 2, 1, 0) * prevalence_caught,
end_stage_3_prev = ifelse(prequel == 3, 1, 0) * prevalence_caught,
end_stage_4_prev = ifelse(prequel == 4, 1, 0) * prevalence_caught,
start_stage_1 = ifelse(clinical == 1, 1, 0) * caught,#incidence rounds
start_stage_2 = ifelse(clinical == 2, 1, 0) * caught,
start_stage_3 = ifelse(clinical == 3, 1, 0) * caught,
start_stage_4 = ifelse(clinical == 4, 1, 0) * caught,
start_stage_1_prev = ifelse(clinical == 1, 1, 0) * prevalence_caught,#prevalence rounds
start_stage_2_prev = ifelse(clinical == 2, 1, 0) * prevalence_caught,
start_stage_3_prev = ifelse(clinical == 3, 1, 0) * prevalence_caught,
start_stage_4_prev = ifelse(clinical == 4, 1, 0) * prevalence_caught
) %>%
group_by_at(SS_GROUP_AGE_BY_CANCER) %>%
summarize(
end_stage_1 = sum(end_stage_1),#incidence rounds
end_stage_2 = sum(end_stage_2),
end_stage_3 = sum(end_stage_3),
end_stage_4 = sum(end_stage_4),
end_stage_1_prev = sum(end_stage_1_prev),#prevalence rounds
end_stage_2_prev = sum(end_stage_2_prev),
end_stage_3_prev = sum(end_stage_3_prev),
end_stage_4_prev = sum(end_stage_4_prev),
start_stage_1 = sum(start_stage_1),#incidence rounds
start_stage_2 = sum(start_stage_2),
start_stage_3 = sum(start_stage_3),
start_stage_4 = sum(start_stage_4),
start_stage_1_prev = sum(start_stage_1_prev),#prevalence rounds
start_stage_2_prev = sum(start_stage_2_prev),
start_stage_3_prev = sum(start_stage_3_prev),
start_stage_4_prev = sum(start_stage_4_prev)
) %>% #proportional change for each stage
ungroup() %>%
mutate(
stage_1_change = end_stage_1/start_stage_1,
stage_2_change = end_stage_2/start_stage_2,
stage_3_change = end_stage_3/start_stage_3,
stage_4_change = end_stage_4/start_stage_4,
stage_1_change_prev = end_stage_1_prev/start_stage_1_prev,
stage_2_change_prev = end_stage_2_prev/start_stage_2_prev,
stage_3_change_prev = end_stage_3_prev/start_stage_3_prev,
stage_4_change_prev = end_stage_4_prev/start_stage_4_prev
)
# Apply weights to stage distribution results ------------------------------------
#Weights as in MM, account for attrition in steady state programme with invitations starting at 50
#join weights to stage shift, by cancer
weighted_stage_dist_by_cancer <- stage_dist_by_cancer %>%
left_join(weight_screened_by_scenario, by = c("tAge","scenario","perc_skip","model_type"))  %>%
mutate(
weighted_end_stage_1 = end_stage_1 * weight,
weighted_end_stage_2 = end_stage_2 * weight,
weighted_end_stage_3 = end_stage_3 * weight,
weighted_end_stage_4 = end_stage_4 * weight,
weighted_end_stage_1_prev = end_stage_1_prev * weight,
weighted_end_stage_2_prev = end_stage_2_prev * weight,
weighted_end_stage_3_prev = end_stage_3_prev * weight,
weighted_end_stage_4_prev = end_stage_4_prev * weight,
weighted_start_stage_1 = start_stage_1 * weight,
weighted_start_stage_2 = start_stage_2 * weight,
weighted_start_stage_3 = start_stage_3 * weight,
weighted_start_stage_4 = start_stage_4 * weight,
weighted_start_stage_1_prev = start_stage_1_prev * weight,
weighted_start_stage_2_prev = start_stage_2_prev * weight,
weighted_start_stage_3_prev = start_stage_3_prev * weight,
weighted_start_stage_4_prev = start_stage_4_prev * weight,
)
#aggregate across ages - age-weighted
w_SD_by_cancer <- weighted_stage_dist_by_cancer %>%
group_by_at(SS_GROUP_BY_CANCER) %>%
summarize(
weighted_start_stage_1 = sum(weighted_start_stage_1)/sum(weight),
weighted_start_stage_2 = sum(weighted_start_stage_2)/sum(weight),
weighted_start_stage_3 = sum(weighted_start_stage_3)/sum(weight),
weighted_start_stage_4 = sum(weighted_start_stage_4)/sum(weight),
weighted_end_stage_1 = sum(weighted_end_stage_1)/sum(weight),
weighted_end_stage_2 = sum(weighted_end_stage_2)/sum(weight),
weighted_end_stage_3 = sum(weighted_end_stage_3)/sum(weight),
weighted_end_stage_4 = sum(weighted_end_stage_4)/sum(weight),
weighted_start_stage_1_prev = sum(weighted_start_stage_1_prev)/sum(weight),
weighted_start_stage_2_prev = sum(weighted_start_stage_2_prev)/sum(weight),
weighted_start_stage_3_prev = sum(weighted_start_stage_3_prev)/sum(weight),
weighted_start_stage_4_prev = sum(weighted_start_stage_4_prev)/sum(weight),
weighted_end_stage_1_prev = sum(weighted_end_stage_1_prev)/sum(weight),
weighted_end_stage_2_prev = sum(weighted_end_stage_2_prev)/sum(weight),
weighted_end_stage_3_prev = sum(weighted_end_stage_3_prev)/sum(weight),
weighted_end_stage_4_prev = sum(weighted_end_stage_4_prev)/sum(weight)
) %>%
ungroup()%>% #proportional change for each stage (weighted)
mutate(
weighted_stage_1_change = weighted_end_stage_1/weighted_start_stage_1,
weighted_stage_2_change = weighted_end_stage_2/weighted_start_stage_2,
weighted_stage_3_change = weighted_end_stage_3/weighted_start_stage_3,
weighted_stage_4_change = weighted_end_stage_4/weighted_start_stage_4,
weighted_stage_1_change_prev = weighted_end_stage_1_prev/weighted_start_stage_1_prev,
weighted_stage_2_change_prev = weighted_end_stage_2_prev/weighted_start_stage_2_prev,
weighted_stage_3_change_prev = weighted_end_stage_3_prev/weighted_start_stage_3_prev,
weighted_stage_4_change_prev = weighted_end_stage_4_prev/weighted_start_stage_4_prev
)
#birth cohort results - stage distribution
#prevalence round at age 55 + sum of all the incidence rounds from 56
#remove the incidence round at age 50, so as not to double count it
weighted_sd_no55 = weighted_stage_dist_by_cancer %>%
mutate(weighted_start_stage_1 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_1)) %>%
mutate(weighted_start_stage_2 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_2)) %>%
mutate(weighted_start_stage_3 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_3)) %>%
mutate(weighted_start_stage_4 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_start_stage_4)) %>%
mutate(weighted_end_stage_1 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_1)) %>%
mutate(weighted_end_stage_2 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_2)) %>%
mutate(weighted_end_stage_3 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_3)) %>%
mutate(weighted_end_stage_4 = case_when(tAge == 55 ~ 0,
TRUE ~ weighted_end_stage_4))
# SS_GROUP_BY_CANCER = c("NCRAS_Draw","scenario", "perc_skip","model_type")
np_SD_res <-  weighted_sd_no55 %>%
arrange(tAge) %>%
group_by_at(SS_GROUP_BY_CANCER) %>%
summarize(weighted_start_stage_1_SA = first(weighted_start_stage_1_prev), #to take the prevalence screen at age 50
weighted_start_stage_2_SA = first(weighted_start_stage_2_prev),
weighted_start_stage_3_SA = first(weighted_start_stage_3_prev),
weighted_start_stage_4_SA = first(weighted_start_stage_4_prev),
weighted_end_stage_1_SA = first(weighted_end_stage_1_prev),
weighted_end_stage_2_SA = first(weighted_end_stage_2_prev),
weighted_end_stage_3_SA = first(weighted_end_stage_3_prev),
weighted_end_stage_4_SA = first(weighted_end_stage_4_prev),
weighted_start_stage_1 = sum(weighted_start_stage_1), #to sum all incident rounds of screening age 51-79
weighted_start_stage_2 = sum(weighted_start_stage_2),
weighted_start_stage_3 = sum(weighted_start_stage_3),
weighted_start_stage_4 = sum(weighted_start_stage_4),
weighted_end_stage_1 = sum(weighted_end_stage_1),
weighted_end_stage_2 = sum(weighted_end_stage_2),
weighted_end_stage_3 = sum(weighted_end_stage_3),
weighted_end_stage_4 = sum(weighted_end_stage_4)) %>%
mutate(weighted_start_stage_1= weighted_start_stage_1 + weighted_start_stage_1_SA,
weighted_start_stage_2= weighted_start_stage_2 + weighted_start_stage_2_SA,
weighted_start_stage_3= weighted_start_stage_3 + weighted_start_stage_3_SA,
weighted_start_stage_4= weighted_start_stage_4 + weighted_start_stage_4_SA,
weighted_end_stage_1= weighted_end_stage_1 + weighted_end_stage_1_SA,
weighted_end_stage_2= weighted_end_stage_2 + weighted_end_stage_2_SA,
weighted_end_stage_3= weighted_end_stage_3 + weighted_end_stage_3_SA,
weighted_end_stage_4= weighted_end_stage_4 + weighted_end_stage_4_SA) %>%
ungroup()%>% #proportional change for each stage (weighted)
mutate(
weighted_stage_1_change = weighted_end_stage_1/weighted_start_stage_1,
weighted_stage_2_change = weighted_end_stage_2/weighted_start_stage_2,
weighted_stage_3_change = weighted_end_stage_3/weighted_start_stage_3,
weighted_stage_4_change = weighted_end_stage_4/weighted_start_stage_4,
)
#Filter to base case only
np_SD_res_base <- np_SD_res %>%
filter(scenario == "old_4",
perc_skip == 0,
model_type == "main")
#Output result
#write out excel file
write.xlsx(np_SD_res_base, sprintf("~/Miscellaneous/Treatments/interception_model_results/%s_np_SD_res_50reducedsens_55to79.xlsx", date_code))
1/0
0/0
0/1
